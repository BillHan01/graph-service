<!DOCTYPE html>
<html>
<body>
    <h3>åˆ›å»ºæ–°é¡¹ç›®</h3>
    <div id="create-project-container">
        <input type="text" id="project-name-input" placeholder="è¯·è¾“å…¥é¡¹ç›®åç§°">
        <button onclick="createProject()">åˆ›å»ºé¡¹ç›®</button>
        <p id="create-status"></p>
    </div>

    <h3>ç¬”è®°æäº¤</h3>
    <div id="form-container">
        <form id="note-form">
            <label>é€‰æ‹©é¡¹ç›®ï¼ˆproject_nameï¼‰ï¼š</label>
            <div style="max-height: 150px; overflow-y: auto;">
                <select name="project_name" id="submit-project-select" size="5"></select>
            </div>

            <label>æ–‡ç« æ ‡é¢˜ï¼ˆarticle_titleï¼‰ï¼š</label>
            <input type="text" name="article_title" required>

            <label>åŸæ–‡ï¼ˆoriginï¼‰</label>
            <textarea name="origin" required></textarea>

            <label>ç¬”è®°ï¼ˆcommentï¼‰</label>
            <textarea name="comment"></textarea>

            <button type="submit">æäº¤ç¬”è®°</button>
        </form>
        <p id="status"></p>
    </div>

    <h3>æ‘˜è¦æäº¤</h3>
    <div id="form-container">
        <form id="summary-form">
            <label>é€‰æ‹©é¡¹ç›®ï¼š</label>
            <div style="max-height: 150px; overflow-y: auto;">
                <select name="project_name" id="summary-project-select" size="5"></select>
            </div>

            <label>æ–‡ç« æ ‡é¢˜ï¼ˆarticle_titleï¼‰ï¼š</label>
            <input type="text" name="article_title" required>

            <label>ç« èŠ‚æ•°æ®ï¼ˆchapterï¼‰</label>
            <textarea name="chapter"></textarea>

            <label>ç« èŠ‚æ‘˜è¦ï¼ˆsummaryï¼‰</label>
            <textarea name="summary" required></textarea>

            <button type="submit">æäº¤æ¦‚è¿°</button>
        </form>
        <p id="status"></p>
    </div>

    <h3>æœç´¢å›¾è°±</h3>
    <form id="search-form">
        <label>é€‰æ‹©é¡¹ç›®ï¼š</label>
        <div style="max-height: 150px; overflow-y: auto;">
            <select name="project_name" id="retrieval-project-select" size="5"></select>
        </div>
        <label>æŸ¥è¯¢å†…å®¹ï¼š</label>
        <input type="text" name="query" required>

        <label>æœç´¢èŒƒå›´ï¼š</label>
        <select name="scope">
            <option value="nodes">èŠ‚ç‚¹</option>
            <option value="episodes">ç¬”è®°</option>
        </select>

        <button type="submit">æœç´¢</button>
    </form>
    <div id="search-result"></div>

    <!-- <h3>çŸ¥è¯†å›¾è°±</h3>
    <button onclick="reloadGraph()">åˆ·æ–°å›¾è°±</button>
    <iframe id="graph-frame" src="/graph?user_id=Countries" width="100%" height="600px" style="border:1px solid #ccc;"></iframe> -->
    <!-- <h3>çŸ¥è¯†å›¾è°±</h3> -->
    <!-- <button onclick="reloadGraph()">åˆ·æ–°å›¾è°±</button> -->
    <!-- <div id="mynetwork"
        style="width: 100%; height: 700px; min-height: 600px; border: 1px solid #ccc; background-color: #fff;">
    </div> -->
    <h3 style="text-align:center; font-weight: 600; font-size: 28px; color: #fff; margin-top: 30px;">
    ğŸ“š çŸ¥è¯†å›¾è°±
    </h3>
    <div style="text-align:center; margin-bottom: 16px;">
    <button onclick="reloadGraph()" style="
        padding: 8px 18px;
        font-size: 14px;
        background: #2f2f2f;
        border: 1px solid #444;
        border-radius: 8px;
        color: #eee;
        cursor: pointer;
        transition: background 0.2s ease;
    " onmouseover="this.style.background='#444'" onmouseout="this.style.background='#2f2f2f'">åˆ·æ–°å›¾è°±</button>
    </div>

    <!-- å›¾è°±å®¹å™¨ -->
    <div id="mynetwork" style="
        width: 100%;
        height: 700px;
        min-height: 600px;
        background: radial-gradient(circle at center, #1a1a1a 0%, #121212 100%);
        border: none;
        border-radius: 18px;
        box-shadow: 0 0 20px rgba(0,0,0,0.3);
        margin: auto;
        position: relative;
        overflow: hidden;
    "></div>

    <!-- å¼¹å‡ºçª—å£ -->
    <!-- <div id="node-popup" style="
        display: none;
        position: fixed;
        top: 15%;
        left: 50%;
        transform: translate(-50%, -15%);
        width: 420px;
        max-height: 500px;
        overflow-y: auto;
        padding: 24px;
        background: #1a1a1a;
        color: #eee;
        border-radius: 16px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
        font-family: 'Helvetica Neue', sans-serif;
        font-size: 15px;
        line-height: 1.6;
        z-index: 1000;
    ">
    <div id="popup-content"></div>
    <div style="text-align:right; margin-top: 16px;">
        <button onclick="document.getElementById('node-popup').style.display='none'" style="
            background: transparent;
            border: 1px solid #555;
            color: #ccc;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        ">å…³é—­</button>
    </div> -->
    </div>


    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script>

        // æ¨¡æ‹Ÿå·²æœ‰é¡¹ç›®åˆ—è¡¨ï¼ˆå¯æ”¹ä¸ºåç«¯åŠ¨æ€æ‹‰å–ï¼‰
        const projectList = ["Deep-Learning", "Germany-Information", "Coffee-Knowledge"];

        window.onload = () => {
            const submitSelect = document.getElementById("submit-project-select");
            const retrievalSelect = document.getElementById("retrieval-project-select");
            const summarySelect = document.getElementById("summary-project-select");

            for (const name of projectList) {
                const option1 = document.createElement("option");
                option1.value = name;
                option1.textContent = name;
                submitSelect.appendChild(option1);

                const option2 = document.createElement("option");
                option2.value = name;
                option2.textContent = name;
                retrievalSelect.appendChild(option2);

                const option3 = document.createElement("option");
                option3.value = name;
                option3.textContent = name;
                summarySelect.appendChild(option3);
            }

            // åˆå§‹åŠ è½½å›¾è°±ï¼ˆä»¥æäº¤è¡¨å•çš„é€‰ä¸­å€¼ä¸ºå‡†ï¼‰
            reloadGraph();
        };

        // === ä¸Šä¼ æ‘˜è¦åŠŸèƒ½ ===
        document.getElementById("summary-form").addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch("/submitsummary", {
                method: "POST",
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                const status = document.getElementById("status");
                if (data.status === "success") {
                    status.textContent = "æäº¤æˆåŠŸï¼";
                    reloadGraph(); // åˆ·æ–° iframe
                } else {
                    status.textContent = "æäº¤å¤±è´¥ï¼š" + data.message;
                }
            });
        });

        // === ä¸Šä¼ ç¬”è®°åŠŸèƒ½ ===
        document.getElementById("note-form").addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch("/submitnote", {
                method: "POST",
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                const status = document.getElementById("status");
                if (data.status === "success") {
                    status.textContent = "æäº¤æˆåŠŸï¼";
                    reloadGraph(); // åˆ·æ–° iframe
                } else {
                    status.textContent = "æäº¤å¤±è´¥ï¼š" + data.message;
                }
            });
        });

        // === åˆ·æ–°å›¾è°±åŠŸèƒ½ ===
        // function reloadGraph() {
        //     const selectedProject = document.getElementById("submit-project-select").value;
        //     const frame = document.getElementById("graph-frame");
        //     frame.src = "/graph?user_id=" + encodeURIComponent(selectedProject) + "&ts=" + Date.now(); // åŠ æ—¶é—´æˆ³é˜²ç¼“å­˜
        // }
        function processNodes(rawNodes) {
            return rawNodes.map(n => ({
                ...n,
                shape: "circle",
                fixed: { width: true, height: true },
                widthConstraint: { maximum: 80 },
                font: { size: 14 }
            }));
        }

        // function handleNodeClick(params, nodes) {
        //     if (params.nodes.length === 0) return;

        //     const nodeId = params.nodes[0];
        //     const nodeData = nodes.get(nodeId);

        //     const contentHTML = `
        //         <strong>èŠ‚ç‚¹åç§°ï¼š</strong> ${nodeData.label}<br>
        //         <strong>æ‘˜è¦ï¼š</strong><br>
        //         <div style="white-space: pre-wrap; margin-bottom: 8px;">
        //             ${nodeData.title || "(æ— æ‘˜è¦)"}
        //         </div>
        //         <strong>åˆ›å»ºæ—¶é—´ï¼š</strong> ${formatDate(nodeData.created_at) || "(æœªçŸ¥)"}<br>
        //     `;
        //     document.getElementById("popup-content").innerHTML = contentHTML;
        //     document.getElementById("node-popup").style.display = "block";
        // }
        function handleNodeClick(params, nodes) {
            if (params.nodes.length === 0) return;

            const nodeId = params.nodes[0];
            const nodeData = nodes.get(nodeId);
            const nodeUUID = nodeData.id;

            const popup = document.getElementById("node-popup");
            const popupContent = document.getElementById("popup-content");

            // 1. åˆå§‹åŠ è½½å†…å®¹ï¼ˆèŠ‚ç‚¹åŸºç¡€ä¿¡æ¯ï¼‰
            popupContent.innerHTML = `
                <strong>èŠ‚ç‚¹åç§°ï¼š</strong> ${nodeData.label}<br>
                <strong>çŸ¥è¯†æè¿°ï¼š</strong><br>
                <div style="white-space: pre-wrap; margin-bottom: 8px;">
                    ${nodeData.title || "(æ— æ‘˜è¦)"}
                </div>
                <strong>åˆ›å»ºæ—¶é—´ï¼š</strong> ${formatDate(nodeData.created_at) || "(æœªçŸ¥)"}<br>
                <hr>
                <div id="episode-loading">æ­£åœ¨åŠ è½½ç›¸å…³ç¬”è®°ä¸æ‘˜è¦...</div>
            `;
            popup.style.display = "block";

            // 2. å¼‚æ­¥è¯·æ±‚èŠ‚ç‚¹ç›¸å…³ Episode
            fetch(`/node_episodes?node_uuid=${encodeURIComponent(nodeUUID)}`)
                .then(res => res.json())
                .then(data => {
                    const loadingDiv = document.getElementById("episode-loading");
                    if (data.status !== "success") {
                        loadingDiv.innerHTML = `<span style="color:red;">åŠ è½½å¤±è´¥ï¼š${data.message}</span>`;
                        return;
                    }

                    if (data.episodes.length === 0) {
                        loadingDiv.innerHTML = `æš‚æ— å…³è”ç¬”è®°æˆ–æ‘˜è¦ã€‚`;
                        return;
                    }

                    // åˆ†ç»„ï¼šå…ˆ noteï¼Œå summaryï¼ˆå¯é€‰ï¼‰
                    const notes = data.episodes.filter(ep => ep.type === "note");
                    const summaries = data.episodes.filter(ep => ep.type === "summary");

                    let combinedHTML = "";

                    if (notes.length > 0) {
                        combinedHTML += `<h4>å…³è”ç¬”è®°</h4>`;
                        combinedHTML += notes.map(ep => `
                            <div style="margin-bottom: 10px; border-bottom: 1px dashed #ccc; padding-bottom: 6px;">
                                <strong>${ep.article_title}</strong><br>
                                <span style="color: #666;">${formatDate(ep.created_at)}</span><br>
                                <div style="white-space: pre-wrap; font-size: 14px;">
                                    ${ep.comment || "(æ— å†…å®¹)"}
                                </div>
                            </div>
                        `).join("");
                    }

                    if (summaries.length > 0) {
                        combinedHTML += `<h4>å…³è”æ‘˜è¦</h4>`;
                        combinedHTML += summaries.map(ep => `
                            <div style="margin-bottom: 10px; border-bottom: 1px dashed #ccc; padding-bottom: 6px;">
                                <strong>${ep.article_title}</strong><br>
                                <span style="color: #666;">${formatDate(ep.created_at)}</span><br>
                                ${ep.chapter ? `<div style="color: #888;">ç« èŠ‚ï¼š${ep.chapter}</div>` : ""}
                                <div style="white-space: pre-wrap; font-size: 14px;">
                                    ${ep.summary || "(æ— æ‘˜è¦å†…å®¹)"}
                                </div>
                            </div>
                        `).join("");
                    }

                    loadingDiv.outerHTML = `<div style="margin-top: 10px;">${combinedHTML}</div>`;
                })
                .catch(err => {
                    document.getElementById("episode-loading").innerHTML =
                        `<span style="color:red;">ç½‘ç»œé”™è¯¯ï¼š${err.message}</span>`;
                });
        }

        
        function formatDate(raw) {
            if (!raw) return null;
            const date = new Date(raw);
            return isNaN(date) ? raw : date.toLocaleString();
        }
        function reloadGraph() {
            const selectedProject = document.getElementById("submit-project-select").value;
            fetch("/graph_data?user_id=" + encodeURIComponent(selectedProject))
                .then(res => res.json())
                .then(data => {
                    if (data.status !== "success") {
                        alert("å›¾è°±åŠ è½½å¤±è´¥ï¼š" + data.message);
                        return;
                    }

                    const nodes = new vis.DataSet(processNodes(data.nodes));
                    const edges = new vis.DataSet(data.edges);
                    const container = document.getElementById("mynetwork");

                    const options = {
                    nodes: {
                    shape: "dot",
                    size: 30,  // èŠ‚ç‚¹åŸºç¡€å¤§å°ï¼Œåç»­å¯æ ¹æ® degree åŠ¨æ€æ˜ å°„
                    font: {
                        face: "Helvetica Neue, Inter, sans-serif",
                        size: 16,
                        color: "#FFFFFF",
                        strokeWidth: 0,
                        bold: {
                        color: "#FFFFFF",
                        size: 18, // é¼ æ ‡æ‚¬æµ®æ—¶ç¨å¤§
                        face: "Helvetica Neue"
                        }
                    },
                    color: {
                        background: "#2C2C2E",
                        border: "#4F4F4F",
                        highlight: {
                        background: "#444",  // æ”¹ä¸ºæ·±ç°
                        border: "#888"       // æŸ”å’Œè¾¹æ¡†é«˜äº®
                        },
                        hover: {
                        background: "#555",
                        border: "#AAA"
                        }
                    },
                    borderWidth: 1,
                    borderWidthSelected: 2
                    },
                    edges: {
                    color: {
                        color: "#999999",
                        highlight: "#ffffff",
                        hover: "#ffffff"
                    },
                    width: 1,
                    smooth: {
                        type: "dynamic"
                    },
                    font: {
                        color: "#bbbbbb",
                        size: 12,
                        face: "Inter, Helvetica Neue, sans-serif",
                        background: "rgba(30, 30, 30, 0.5)",
                        strokeWidth: 0,
                        align: "middle",
                        vadjust: -2
                    },
                    arrows: {
                        to: { enabled: false }
                    }
                    },
                    interaction: {
                        hover: true,
                        tooltipDelay: 100,
                        hideEdgesOnDrag: false
                    },
                    physics: {
                        enabled: true,
                        solver: "forceAtlas2Based",
                        forceAtlas2Based: {
                        gravitationalConstant: -45,
                        centralGravity: 0.02,
                        springLength: 140,
                        springConstant: 0.05,
                        damping: 0.6
                        },
                        stabilization: {
                        enabled: true,
                        iterations: 250,
                        fit: true
                        }
                    },
                    layout: {
                        improvedLayout: true
                    }
                    };


                    // const options = {
                    //     layout: {
                    //         improvedLayout: true
                    //     },
                    //     nodes: {
                    //         shape: "dot",
                    //         size: 18,
                    //         font: {
                    //             size: 15,
                    //             color: "#333",
                    //             face: "Helvetica Neue, Segoe UI, San Francisco, sans-serif"
                    //         },
                    //         color: {
                    //             background: "#f8f8f8",
                    //             border: "#cccccc",
                    //             highlight: {
                    //                 background: "#ffffff",
                    //                 border: "#666666"
                    //             },
                    //             hover: {
                    //                 background: "#f0f0f0",
                    //                 border: "#999999"
                    //             }
                    //         },
                    //         borderWidth: 1,
                    //         borderWidthSelected: 2
                    //     },
                    //     edges: {
                    //         width: 1,
                    //         color: {
                    //             color: "#d0d0d0",
                    //             highlight: "#888888",
                    //             hover: "#aaaaaa"
                    //         },
                    //         arrows: {
                    //             to: { enabled: true, scaleFactor: 0.4 }
                    //         },
                    //         smooth: {
                    //             type: "dynamic"
                    //         }
                    //     },
                    //     interaction: {
                    //         hover: true,
                    //         tooltipDelay: 100,
                    //         navigationButtons: false,
                    //         keyboard: false,
                    //         zoomView: true,
                    //         dragView: true
                    //     },
                    //     physics: {
                    //         enabled: true,
                    //         solver: "forceAtlas2Based",
                    //         forceAtlas2Based: {
                    //             gravitationalConstant: -30,
                    //             centralGravity: 0.008,
                    //             springLength: 140,
                    //             springConstant: 0.06,
                    //             damping: 0.4,
                    //             avoidOverlap: 1
                    //         },
                    //         stabilization: {
                    //             enabled: true,
                    //             iterations: 200
                    //         },
                    //         minVelocity: 0.75
                    //     }
                    // };

                    const network = new vis.Network(container, { nodes, edges }, options);

                    // const network = new vis.Network(container, { nodes, edges }, {
                    //     physics: {
                    //         enabled: true,
                    //         solver: "forceAtlas2Based",
                    //         forceAtlas2Based: {
                    //             gravitationalConstant: -50,
                    //             centralGravity: 0.01,
                    //             springLength: 120,
                    //             springConstant: 0.08,
                    //             damping: 0.4,
                    //             avoidOverlap: 1,
                    //         },
                    //         stabilization: { enabled: true, iterations: 200 },
                    //         minVelocity: 0.75
                    //     }
                    // });

                    network.on("click", params => handleNodeClick(params, nodes));
                });
        }


        // === æœç´¢èŠ‚ç‚¹åŠŸèƒ½ ===
        document.getElementById("search-form").addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch("/search", {
                method: "POST",
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                const resultBox = document.getElementById("search-result");
                if (data.status === "success") {
                    if (data.results.length === 0) {
                        resultBox.innerHTML = "<p>æœªæ‰¾åˆ°åŒ¹é…é¡¹ã€‚</p>";
                    } else {
                        let html = "<ul>";
                        for (const item of data.results) {
                            if (item.type === "node") {
                                html += `<li>
                                    <strong>${item.index}. ${item.name || 'æœªå‘½åèŠ‚ç‚¹'}</strong><br>
                                    <em>${item.summary || 'æ— æ‘˜è¦ä¿¡æ¯'}</em><br>
                                    <small>åˆ›å»ºæ—¶é—´ï¼š${item.created_at}</small>
                                </li>`;
                            } else if (item.type === "episode") {
                                html += `<li>
                                    <strong>${item.index}. ${item.article_title}</strong><br>
                                    <b>é¡¹ç›®ï¼š</b>${item.project_name}<br>
                                    <b>åŸæ–‡ï¼š</b>${item.origin}<br>
                                    <b>ç¬”è®°ï¼š</b>${item.comment}<br>
                                    <small>åˆ›å»ºæ—¶é—´ï¼š${item.created_at}</small>
                                </li>`;
                            }
                        }
                        html += "</ul>";
                        resultBox.innerHTML = html;
                    }
                } else {
                    resultBox.innerHTML = "æœç´¢å¤±è´¥ï¼š" + data.message;
                }
            });
        });

        // === åˆ›å»ºé¡¹ç›®åŠŸèƒ½ ===
        function createProject() {
            const input = document.getElementById("project-name-input");
            const name = input.value.trim();
            const statusBox = document.getElementById("create-status");

            if (!name) {
                statusBox.textContent = "é¡¹ç›®åç§°ä¸èƒ½ä¸ºç©º";
                return;
            }

            fetch("/create_project", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ project_name: name })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === "success") {
                    statusBox.textContent = `é¡¹ç›® "${name}" åˆ›å»ºæˆåŠŸ`;
                    input.value = "";
                } else {
                    statusBox.textContent = "åˆ›å»ºå¤±è´¥ï¼š" + data.message;
                }
            })
            .catch(err => {
                statusBox.textContent = "è¯·æ±‚å‡ºé”™ï¼š" + err;
            });
        }
    </script>

    
</body>

<style>
  #node-popup {
    display: none;
    position: fixed;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 540px;
    max-height: 80vh;
    background-color: #1e1e1e;
    color: #f2f2f2;
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Segoe UI", Roboto, sans-serif;
    overflow: hidden;
    border: 1px solid #333;
    backdrop-filter: blur(12px);
  }

  #popup-header {
    padding: 20px;
    font-size: 18px;
    font-weight: 600;
    border-bottom: 1px solid #333;
    background-color: rgba(30, 30, 30, 0.9);
  }

  #popup-content {
    padding: 20px;
    max-height: 55vh;
    overflow-y: auto;
    font-size: 15px;
    line-height: 1.7;
    color: #ddd;
  }

  #popup-content p {
    margin-bottom: 16px;
  }

  #popup-footer {
    padding: 16px 20px;
    border-top: 1px solid #333;
    background-color: rgba(30, 30, 30, 0.9);
    text-align: right;
  }

  #popup-footer button {
    background-color: #2a2a2a;
    color: #eee;
    border: 1px solid #444;
    padding: 8px 18px;
    font-size: 14px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  #popup-footer button:hover {
    background-color: #444;
  }

  /* æ»šåŠ¨æ¡æ ·å¼ï¼šæç®€ç°è‰²ç»†çº¿ */
  #popup-content::-webkit-scrollbar {
    width: 6px;
  }
  #popup-content::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 3px;
  }
</style>

<div id="node-popup">
  <div id="popup-header">èŠ‚ç‚¹ä¿¡æ¯</div>
  <div id="popup-content">
    <!-- JavaScript åŠ¨æ€å¡«å……å†…å®¹ -->
  </div>
  <div id="popup-footer">
    <button onclick="document.getElementById('node-popup').style.display='none'">å…³é—­</button>
  </div>
</div>



</html>
