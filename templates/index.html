<!DOCTYPE html>
<html>
<body>
    <h2>Zep 图谱笔记提交与可视化</h2>

    <div id="form-container">
        <form id="note-form">
            <label>原文（origin）</label>
            <textarea name="origin" required></textarea>

            <label>笔记（comment）</label>
            <textarea name="comment"></textarea>

            <button type="submit">提交笔记</button>
        </form>
        <p id="status"></p>
    </div>

    <h3>搜索图谱</h3>
    <form id="search-form">
        <label>查询内容：</label>
        <input type="text" name="query" required>

        <label>搜索范围：</label>
        <select name="scope">
            <option value="nodes">节点</option>
            <option value="episodes">笔记</option>
        </select>

        <button type="submit">搜索</button>
    </form>
    <div id="search-result"></div>

    <h3>知识图谱</h3>
    <button onclick="reloadGraph()">刷新图谱</button>
    <iframe id="graph-frame" src="/graph" width="100%" height="600px" style="border:1px solid #ccc;"></iframe>

    <script>
        document.getElementById("note-form").addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch("/submit", {
                method: "POST",
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                const status = document.getElementById("status");
                if (data.status === "success") {
                    status.textContent = "✅ 提交成功！";
                    reloadGraph(); // 刷新 iframe
                } else {
                    status.textContent = "❌ 提交失败：" + data.message;
                }
            });
        });

        function reloadGraph() {
            const frame = document.getElementById("graph-frame");
            frame.src = frame.src; // 强制刷新 iframe
        }

        // === 搜索节点功能 ===
        document.getElementById("search-form").addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch("/search", {
                method: "POST",
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                const resultBox = document.getElementById("search-result");
                if (data.status === "success") {
                    if (data.results.length === 0) {
                        resultBox.innerHTML = "<p>未找到匹配项。</p>";
                    } else {
                        let html = "<ul>";
                        for (const item of data.results) {
                            if (item.type === "node") {
                                html += `<li>
                                    <strong>${item.index}. ${item.name || '未命名节点'}</strong><br>
                                    <em>${item.summary || '无摘要信息'}</em><br>
                                    <small>创建时间：${item.created_at}</small>
                                </li>`;
                            } else if (item.type === "episode") {
                                html += `<li>
                                    <strong>${item.index}. ${item.article_title}</strong><br>
                                    <b>项目：</b>${item.project_name}<br>
                                    <b>原文：</b>${item.origin}<br>
                                    <b>笔记：</b>${item.comment}<br>
                                    <small>创建时间：${item.created_at}</small>
                                </li>`;
                            }
                        }
                        html += "</ul>";
                        resultBox.innerHTML = html;
                    }
                } else {
                    resultBox.innerHTML = "搜索失败：" + data.message;
                }
            });
        });


    </script>
</body>
</html>
