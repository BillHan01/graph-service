<!DOCTYPE html>
<html>
<body>
    <h3>创建新项目</h3>
    <div id="create-project-container">
        <input type="text" id="project-name-input" placeholder="请输入项目名称">
        <button onclick="createProject()">创建项目</button>
        <p id="create-status"></p>
    </div>

    <h3>笔记提交</h3>
    <div id="form-container">
        <form id="note-form">
            <label>选择项目（project_name）：</label>
            <div style="max-height: 150px; overflow-y: auto;">
                <select name="project_name" id="submit-project-select" size="5"></select>
            </div>

            <label>文章标题（article_title）：</label>
            <input type="text" name="article_title" required>

            <label>原文（origin）</label>
            <textarea name="origin" required></textarea>

            <label>笔记（comment）</label>
            <textarea name="comment"></textarea>

            <button type="submit">提交笔记</button>
        </form>
        <p id="status"></p>
    </div>

    <h3>摘要提交</h3>
    <div id="form-container">
        <form id="summary-form">
            <label>选择项目：</label>
            <div style="max-height: 150px; overflow-y: auto;">
                <select name="project_name" id="summary-project-select" size="5"></select>
            </div>

            <label>文章标题（article_title）：</label>
            <input type="text" name="article_title" required>

            <label>章节数据（chapter）</label>
            <textarea name="chapter"></textarea>

            <label>章节摘要（summary）</label>
            <textarea name="summary" required></textarea>

            <button type="submit">提交概述</button>
        </form>
        <p id="status"></p>
    </div>

    <h3>搜索图谱</h3>
    <form id="search-form">
        <label>选择项目：</label>
        <div style="max-height: 150px; overflow-y: auto;">
            <select name="project_name" id="retrieval-project-select" size="5"></select>
        </div>
        <label>查询内容：</label>
        <input type="text" name="query" required>

        <label>搜索范围：</label>
        <select name="scope">
            <option value="nodes">节点</option>
            <option value="episodes">笔记</option>
        </select>

        <button type="submit">搜索</button>
    </form>
    <div id="search-result"></div>

    <h3>知识图谱</h3>
    <button onclick="reloadGraph()">刷新图谱</button>
    <iframe id="graph-frame" src="/graph?user_id=Countries" width="100%" height="600px" style="border:1px solid #ccc;"></iframe>
    <script>
        // 模拟已有项目列表（可改为后端动态拉取）
        const projectList = ["Deep-Learning", "Germany-Information", "Coffee-Knowledge"];

        window.onload = () => {
            const submitSelect = document.getElementById("submit-project-select");
            const retrievalSelect = document.getElementById("retrieval-project-select");
            const summarySelect = document.getElementById("summary-project-select");

            for (const name of projectList) {
                const option1 = document.createElement("option");
                option1.value = name;
                option1.textContent = name;
                submitSelect.appendChild(option1);

                const option2 = document.createElement("option");
                option2.value = name;
                option2.textContent = name;
                retrievalSelect.appendChild(option2);

                const option3 = document.createElement("option");
                option3.value = name;
                option3.textContent = name;
                summarySelect.appendChild(option3);
            }

            // 初始加载图谱（以提交表单的选中值为准）
            reloadGraph();
        };

        // === 上传摘要功能 ===
        document.getElementById("summary-form").addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch("/submitsummary", {
                method: "POST",
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                const status = document.getElementById("status");
                if (data.status === "success") {
                    status.textContent = "提交成功！";
                    reloadGraph(); // 刷新 iframe
                } else {
                    status.textContent = "提交失败：" + data.message;
                }
            });
        });

        // === 上传笔记功能 ===
        document.getElementById("note-form").addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch("/submitnote", {
                method: "POST",
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                const status = document.getElementById("status");
                if (data.status === "success") {
                    status.textContent = "提交成功！";
                    reloadGraph(); // 刷新 iframe
                } else {
                    status.textContent = "提交失败：" + data.message;
                }
            });
        });

        // === 刷新图谱功能 ===
        function reloadGraph() {
            const selectedProject = document.getElementById("submit-project-select").value;
            const frame = document.getElementById("graph-frame");
            frame.src = "/graph?user_id=" + encodeURIComponent(selectedProject) + "&ts=" + Date.now(); // 加时间戳防缓存
        }

        // === 搜索节点功能 ===
        document.getElementById("search-form").addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch("/search", {
                method: "POST",
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                const resultBox = document.getElementById("search-result");
                if (data.status === "success") {
                    if (data.results.length === 0) {
                        resultBox.innerHTML = "<p>未找到匹配项。</p>";
                    } else {
                        let html = "<ul>";
                        for (const item of data.results) {
                            if (item.type === "node") {
                                html += `<li>
                                    <strong>${item.index}. ${item.name || '未命名节点'}</strong><br>
                                    <em>${item.summary || '无摘要信息'}</em><br>
                                    <small>创建时间：${item.created_at}</small>
                                </li>`;
                            } else if (item.type === "episode") {
                                html += `<li>
                                    <strong>${item.index}. ${item.article_title}</strong><br>
                                    <b>项目：</b>${item.project_name}<br>
                                    <b>原文：</b>${item.origin}<br>
                                    <b>笔记：</b>${item.comment}<br>
                                    <small>创建时间：${item.created_at}</small>
                                </li>`;
                            }
                        }
                        html += "</ul>";
                        resultBox.innerHTML = html;
                    }
                } else {
                    resultBox.innerHTML = "搜索失败：" + data.message;
                }
            });
        });

        // === 创建项目功能 ===
        function createProject() {
            const input = document.getElementById("project-name-input");
            const name = input.value.trim();
            const statusBox = document.getElementById("create-status");

            if (!name) {
                statusBox.textContent = "项目名称不能为空";
                return;
            }

            fetch("/create_project", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ project_name: name })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === "success") {
                    statusBox.textContent = `项目 "${name}" 创建成功`;
                    input.value = "";
                } else {
                    statusBox.textContent = "创建失败：" + data.message;
                }
            })
            .catch(err => {
                statusBox.textContent = "请求出错：" + err;
            });
        }
    </script>
</body>
</html>
